# Используемые технологии

- [Сверка идентификаторов](#сверка-идентификаторов)
- [Автоматическое тестирование](#автоматическое-тестирование)
- [Сборка поставки](#сборка-поставки)
  - [ГРМ](#грм)
  - [AddDocs](#adddocs)

# Сверка идентификаторов

**Сверка идентификаторов** — процесс экспорта конфигураций из рабочего и релизного хранилищ в XML-файлы с последующим сравнением идентификаторов для выявления различий.

## Файлы

Файлы хранятся в папке `IDENTIFICATOR`:

| Файл                              | Описание                                                                 |
|-----------------------------------|--------------------------------------------------------------------------|
| `Jenkinsfile`                     | Основной файл для запуска процесса в Jenkins.                            |
| `telegram_file_sender.py`         | Отправляет результаты сверки в виде изображения в Telegram.              |
| `configuration_comparison_manager.py` | Формирует таблицу в формате Excel с результатами сверки идентификаторов. |

## Запуск

Процесс полностью автоматизирован. Запуск выполняется через **Jenkins**:

1. Перейдите в раздел **IDENTIFICATOR**.
2. Выберите продукт и нажмите **Собрать**.

Агент выполнения (`master`) находится на сервере 71.

## Принцип работы

1. Подключение к хранилищу и обновление данных.
2. Экспорт конфигурации в XML-файлы.
3. Сравнение идентификаторов с использованием расширения.
4. Формирование отчёта и отправка изображения в Telegram.
5. Очистка рабочего каталога.

## Рабочие каталоги

На сервере 71 в папке `D:\Identificators` хранятся файлы для работы сверки идентификаторов:

- **log**: Логи сборок в формате `xlsx` и сгенерированные изображения для отправки в Telegram.
- **Obarabotka**: Обработки для сверки идентификаторов.
- **Rab**: Конфигурация, выгруженная из рабочего хранилища.
- **Relis**: Конфигурация, выгруженная из релизного хранилища.

![Пример результата сверки](docs/identif.png)

# Автоматическое тестирование

Автоматическое тестирование продукта перед выпуском релиза для обеспечения качества.

## Файлы

Файлы хранятся в папке `tests`:

| Папка/Файл                        | Описание                                                                 |
|-----------------------------------|--------------------------------------------------------------------------|
| `Jenkinsfile`                     | Основной файл запуска Jenkins, адаптированный для трёх продуктов: «Фитнес-клуб», «Салон красоты», «Стоматология». |
| `tools/VAParams.json`             | Настройки для Vanessa Automation.                                        |
| `scripts/AgentRestart.py`         | Перезапускает службу агента сервера 1С.                                 |
| `scripts/drop_db.py`              | Удаляет базу данных из кластера 1С и PostgreSQL.                         |
| `scripts/InitDatabase.bat`        | Запускает функции `vrunner` для инициализации базы.                      |
| `notifications/allure-notifications-4.8.0.jar` | Формирует отчёт Allure и отправляет его в Telegram.                     |
| `notifications/config.json`        | Настройки отчёта Allure и отправки сообщений в Telegram.                 |
| `notifications/logo.png`           | Логотип продукта в отчёте Allure.                                       |
| `features/`                       | Наборы тестов для Vanessa Automation.                                   |
| `epf/`                            | Обработки для тестирования.                                             |
| `cfe/`                            | Расширения конфигурации.                                                |
| `build/`                          | Результаты отчётов Allure.                                              |

## Запуск

Процесс полностью автоматизирован. Запуск выполняется через **Jenkins** для продуктов:

- **fitness** (Фитнес-клуб)
- **salon** (Салон красоты)
- **stoma** (Стоматология)

Агент выполнения (`OneS`) находится на сервере 71.

### Настройка расписания

Тестирование выполняется автоматически в **20:00** по МСК. Для активации периодического запуска в настройках Pipeline продукта включите опцию «Запускать периодически» и укажите расписание: `H 20 * * *`.

![Настройка расписания](docs/trigger.jpg)

## Принцип работы

### 1. Подготовка базы данных

1. Удаление существующей базы данных (при её наличии).
2. Создание новой пустой базы.
3. Загрузка файла `.dt` в новую базу.
4. Обновление конфигурации базы данных.
5. Загрузка данных из релизного хранилища.
6. Повторное обновление конфигурации.

В случае ошибки на любом этапе процесс повторяется до двух раз. При повторной ошибке перезапускается агент сервера 1С, после чего подготовка базы повторяется ещё два раза.

Если база успешно создана и заполнена, проверяется версия релиза:

- Если версия совпадает с текущей в файле `D:\Vanessa-Automation\version`, продолжается выполнение Pipeline.
- Если версия релиза выше, запускаются обработчики обновления, а эталонная база выгружается и заменяется новой версией.

![Процесс подготовки базы](docs/pipeline.jpg)

### 2. Сценарное тестирование

1. Отключение пользователей от базы данных.
2. Выполнение тестов с использованием Vanessa Automation.

### 3. Формирование и отправка отчёта Allure

- Проверяется стабильность результатов тестирования.
- Если результат стабилен или нестабилен, отчёт Allure отправляется в Telegram.
- В противном случае отчёт не отправляется.

![Пример отчёта Allure](docs/allure.jpg)

### 4. Планируемые этапы

- **Дымовые тесты**: Проверка базовой функциональности продукта перед основным тестированием.
- **Syntax-check**: Автоматическая проверка синтаксиса кода.
- **SonarQube**: Анализ качества кода с использованием платформы SonarQube.

## Рабочие каталоги

На сервере 71 в папке `D:\Vanessa-Automation` хранятся файлы эталонных баз и информация о версиях.

![Этапы выполнения](docs/build.jpg)

# Сборка поставки

## ГРМ

**ГРМ** (Глобальный релизный менеджер) — сервис 1С для отправки файла `.dt`, созданного на основе пустой базы актуальной версии релиза.

### Файлы

Файлы хранятся в папке `GRM`:

| Файл               | Описание                                                                 |
|--------------------|--------------------------------------------------------------------------|
| `Jenkinsfile`      | Основной файл для запуска процесса отправки в Jenkins.                   |
| `cleaning.py`      | Очищает содержимое папок `D:\dt` и `D:\cf`.                             |
| `transfer.py`      | Копирует файл `.cf` из папки `Old_versions_cf` в `D:\cf`.               |
| `upload_file.py`   | Выполняет PUT-запрос для отправки файла `.dt` в ГРМ.                     |

### Принцип работы

1. Очистка папок `D:\dt` и `D:\cf`.
2. Получение ссылки на предписание.
3. Копирование файла `.cf` из `D:\release_build\FITNESSCORP\Old_versions_cf` в `D:\cf`.
4. Загрузка файла `.cf` в пустую базу, обновление конфигурации и выгрузка файла `.dt` в папку `D:\dt`.
5. Отправка файла `.dt` в объектное хранилище ГРМ.
6. Установка версии по умолчанию.

### Запуск

Процесс полностью автоматизирован. Запуск выполняется через **Jenkins**:

1. Перейдите в раздел **Сборки релизов → GRM → Собрать с параметрами**.
2. Укажите параметры:
   - **nameProduct**: Выберите продукт (`fitnessCorp`, `SpaSalon3`, `salon30`).
   - **version**: Укажите версию в формате `x.x.xx.x`.
   - **jenkinsAgent**: Оставьте значение по умолчанию.

Агент выполнения (`OneS`) находится на сервере 71.

**Временное примечание**: Файл `.cf` должен находиться по пути `D:\release_build\FITNESSCORP\Old_versions_cf`.

## AddDocs

**AddDocs** — процесс добавления документации к релизу (в разработке). Подробности будут добавлены позже.


<details>
  <summary>Нажмите, чтобы развернуть код</summary>

```bash
# Пример команды
echo "Hello, World!"
```